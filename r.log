Run options: include {:locations=>{"./spec/persistence/sequel/revision/session_spec.rb"=>[133]}}
FF

Failures:

  1) Lims::Core::Persistence::Sequel::Revision::Session With sql test store with object history#linked objects for a specific resource find the correct revision 
     Failure/Error: session.user_session.send(:session_ids_for, resource_state).should ==  session_ids
       expected: [1, 2, 3, 4]
            got: [#<Lims::Core::Persistence::StateGroup: {#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c6416d278 @resource=#<Lims::Core::Persistence::ForTest::User:0x007f9c642685b0 @email="john.smith@example.com", @name=#<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90 @name="jon">>, @persistor=#<Lims::Core::Persistence::ForTest::User::UserSequelRevisionPersistor:0x007f9c64181408 @session=#<Lims::Core::Persistence::Sequel::Revision::Session:0x007f9c64166360 @store=#<Lims::Core::Persistence::Sequel::Store:0x007f9c6292ed38 @database=#<Sequel::SQLite::Database: {:adapter=>:sqlite, :database=>"", :loggers=>[]}>, @dirty_attribute_strategy=2>, @session_id=nil, @object_states=#<Lims::Core::Persistence::StateList: {#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c6416d278 ...>, #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278 @resource=#<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90 @name="jon">, @persistor=#<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268 @session=#<Lims::Core::Persistence::Sequel::Revision::Session:0x007f9c64166360 ...>, @id_to_state={1=>#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278 ...>, 2=>#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0 @resource=#<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970 @name="John">, @persistor=#<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268 ...>, @id=2, @to_delete=false, @last_dirty_key="7a4a69e09c57f13cbdc0a7ff43c314629e0a5f32", @parents_saved=nil, @children_saved=nil, @body_saved=nil, @revision=[#<Lims::Core::Persistence::Revision:0x007f9c641dc8f8 @action="insert", @number=1, @session_id=4, @resource=#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0 ...>>]>}, @object_to_state={#<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90 @name="jon">=>#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278 ...>, #<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970 @name="John">=>#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0 @resource=#<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970 @name="John">, @persistor=#<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268 ...>, @id=2, @to_delete=false, @last_dirty_key="7a4a69e09c57f13cbdc0a7ff43c314629e0a5f32", @parents_saved=nil, @children_saved=nil, @body_saved=nil, @revision=[#<Lims::Core::Persistence::Revision:0x007f9c641dc8f8 @action="insert", @number=1, @session_id=4, @resource=#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0 ...>>]>}, @dataset=#<Sequel::SQLite::Dataset: "SELECT * FROM `names_revision`">, @qualified_key=#<Sequel::SQL::QualifiedIdentifier @table=>:names_revision, @column=>:id>>, @id=1, @to_delete=false, @last_dirty_key="ffc2b6e3fa60e5d56f686a61bd27deee712030f4", @parents_saved=nil, @children_saved=nil, @body_saved=nil, @revision=[#<Lims::Core::Persistence::Revision:0x007f9c64211f58 @action="insert", @number=1, @session_id=1, @resource=#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278 ...>>, #<Lims::Core::Persistence::Revision:0x007f9c6415b1e0 @action="update", @number=2, @session_id=2>]>, #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0 @resource=#<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970 @name="John">, @persistor=#<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268 @session=#<Lims::Core::Persistence::Sequel::Revision::Session:0x007f9c64166360 ...>, @id_to_state={1=>#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278 @resource=#<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90 @name="jon">, @persistor=#<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268 ...>, @id=1, @to_delete=false, @last_dirty_key="ffc2b6e3fa60e5d56f686a61bd27deee712030f4", @parents_saved=nil, @children_saved=nil, @body_saved=nil, @revision=[#<Lims::Core::Persistence::Revision:0x007f9c64211f58 @action="insert", @number=1, @session_id=1, @resource=#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278 ...>>, #<Lims::Core::Persistence::Revision:0x007f9c6415b1e0 @action="update", @number=2, @session_id=2>]>, 2=>#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0 ...>}, @object_to_state={#<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90 @name="jon">=>#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278 @resource=#<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90 @name="jon">, @persistor=#<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268 ...>, @id=1, @to_delete=false, @last_dirty_key="ffc2b6e3fa60e5d56f686a61bd27deee712030f4", @parents_saved=nil, @children_saved=nil, @body_saved=nil, @revision=[#<Lims::Core::Persistence::Revision:0x007f9c64211f58 @action="insert", @number=1, @session_id=1, @resource=#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278 ...>>, #<Lims::Core::Persistence::Revision:0x007f9c6415b1e0 @action="update", @number=2, @session_id=2>]>, #<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970 @name="John">=>#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0 ...>}, @dataset=#<Sequel::SQLite::Dataset: "SELECT * FROM `names_revision`">, @qualified_key=#<Sequel::SQL::QualifiedIdentifier @table=>:names_revision, @column=>:id>>, @id=2, @to_delete=false, @last_dirty_key="7a4a69e09c57f13cbdc0a7ff43c314629e0a5f32", @parents_saved=nil, @children_saved=nil, @body_saved=nil, @revision=[#<Lims::Core::Persistence::Revision:0x007f9c641dc8f8 @action="insert", @number=1, @session_id=4, @resource=#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0 ...>>]>}>, @in_session=false, @saved=#<Set: {}>, @persistor_map={Lims::Core::Persistence::ForTest::User=>#<Lims::Core::Persistence::ForTest::User::UserSequelRevisionPersistor:0x007f9c64181408 ...>, Lims::Core::Persistence::ForTest::Name=>#<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268 @session=#<Lims::Core::Persistence::Sequel::Revision::Session:0x007f9c64166360 ...>, @id_to_state={1=>#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278 @resource=#<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90 @name="jon">, @persistor=#<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268 ...>, @id=1, @to_delete=false, @last_dirty_key="ffc2b6e3fa60e5d56f686a61bd27deee712030f4", @parents_saved=nil, @children_saved=nil, @body_saved=nil, @revision=[#<Lims::Core::Persistence::Revision:0x007f9c64211f58 @action="insert", @number=1, @session_id=1, @resource=#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278 ...>>, #<Lims::Core::Persistence::Revision:0x007f9c6415b1e0 @action="update", @number=2, @session_id=2>]>, 2=>#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0 @resource=#<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970 @name="John">, @persistor=#<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268 ...>, @id=2, @to_delete=false, @last_dirty_key="7a4a69e09c57f13cbdc0a7ff43c314629e0a5f32", @parents_saved=nil, @children_saved=nil, @body_saved=nil, @revision=[#<Lims::Core::Persistence::Revision:0x007f9c641dc8f8 @action="insert", @number=1, @session_id=4, @resource=#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0 ...>>]>}, @object_to_state={#<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90 @name="jon">=>#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278 @resource=#<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90 @name="jon">, @persistor=#<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268 ...>, @id=1, @to_delete=false, @last_dirty_key="ffc2b6e3fa60e5d56f686a61bd27deee712030f4", @parents_saved=nil, @children_saved=nil, @body_saved=nil, @revision=[#<Lims::Core::Persistence::Revision:0x007f9c64211f58 @action="insert", @number=1, @session_id=1, @resource=#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278 ...>>, #<Lims::Core::Persistence::Revision:0x007f9c6415b1e0 @action="update", @number=2, @session_id=2>]>, #<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970 @name="John">=>#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0 @resource=#<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970 @name="John">, @persistor=#<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268 ...>, @id=2, @to_delete=false, @last_dirty_key="7a4a69e09c57f13cbdc0a7ff43c314629e0a5f32", @parents_saved=nil, @children_saved=nil, @body_saved=nil, @revision=[#<Lims::Core::Persistence::Revision:0x007f9c641dc8f8 @action="insert", @number=1, @session_id=4, @resource=#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0 ...>>]>}, @dataset=#<Sequel::SQLite::Dataset: "SELECT * FROM `names_revision`">, @qualified_key=#<Sequel::SQL::QualifiedIdentifier @table=>:names_revision, @column=>:id>>}, @dirty_attribute_strategy=2, @user=nil, @backend_application_id=nil, @parameters=nil>, @id_to_state={1=>#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c6416d278 ...>}, @object_to_state={#<Lims::Core::Persistence::ForTest::User:0x007f9c642685b0 @email="john.smith@example.com", @name=#<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90 @name="jon">>=>#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c6416d278 ...>}, @dataset=#<Sequel::SQLite::Dataset: "SELECT * FROM `users_revision`">, @qualified_key=#<Sequel::SQL::QualifiedIdentifier @table=>:users_revision, @column=>:id>, @session_name=#<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268 @session=#<Lims::Core::Persistence::Sequel::Revision::Session:0x007f9c64166360 @store=#<Lims::Core::Persistence::Sequel::Store:0x007f9c6292ed38 @database=#<Sequel::SQLite::Database: {:adapter=>:sqlite, :database=>"", :loggers=>[]}>, @dirty_attribute_strategy=2>, @session_id=nil, @object_states=#<Lims::Core::Persistence::StateList: {#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c6416d278 ...>, #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278 @resource=#<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90 @name="jon">, @persistor=#<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268 ...>, @id=1, @to_delete=false, @last_dirty_key="ffc2b6e3fa60e5d56f686a61bd27deee712030f4", @parents_saved=nil, @children_saved=nil, @body_saved=nil, @revision=[#<Lims::Core::Persistence::Revision:0x007f9c64211f58 @action="insert", @number=1, @session_id=1, @resource=#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278 ...>>, #<Lims::Core::Persistence::Revision:0x007f9c6415b1e0 @action="update", @number=2, @session_id=2>]>, #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0 @resource=#<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970 @name="John">, @persistor=#<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268 ...>, @id=2, @to_delete=false, @last_dirty_key="7a4a69e09c57f13cbdc0a7ff43c314629e0a5f32", @parents_saved=nil, @children_saved=nil, @body_saved=nil, @revision=[#<Lims::Core::Persistence::Revision:0x007f9c641dc8f8 @action="insert", @number=1, @session_id=4, @resource=#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0 ...>>]>}>, @in_session=false, @saved=#<Set: {}>, @persistor_map={Lims::Core::Persistence::ForTest::User=>#<Lims::Core::Persistence::ForTest::User::UserSequelRevisionPersistor:0x007f9c64181408 ...>, Lims::Core::Persistence::ForTest::Name=>#<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268 ...>}, @dirty_attribute_strategy=2, @user=nil, @backend_application_id=nil, @parameters=nil>, @id_to_state={1=>#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278 @resource=#<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90 @name="jon">, @persistor=#<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268 ...>, @id=1, @to_delete=false, @last_dirty_key="ffc2b6e3fa60e5d56f686a61bd27deee712030f4", @parents_saved=nil, @children_saved=nil, @body_saved=nil, @revision=[#<Lims::Core::Persistence::Revision:0x007f9c64211f58 @action="insert", @number=1, @session_id=1, @resource=#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278 ...>>, #<Lims::Core::Persistence::Revision:0x007f9c6415b1e0 @action="update", @number=2, @session_id=2>]>, 2=>#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0 @resource=#<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970 @name="John">, @persistor=#<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268 ...>, @id=2, @to_delete=false, @last_dirty_key="7a4a69e09c57f13cbdc0a7ff43c314629e0a5f32", @parents_saved=nil, @children_saved=nil, @body_saved=nil, @revision=[#<Lims::Core::Persistence::Revision:0x007f9c641dc8f8 @action="insert", @number=1, @session_id=4, @resource=#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0 ...>>]>}, @object_to_state={#<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90 @name="jon">=>#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278 @resource=#<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90 @name="jon">, @persistor=#<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268 ...>, @id=1, @to_delete=false, @last_dirty_key="ffc2b6e3fa60e5d56f686a61bd27deee712030f4", @parents_saved=nil, @children_saved=nil, @body_saved=nil, @revision=[#<Lims::Core::Persistence::Revision:0x007f9c64211f58 @action="insert", @number=1, @session_id=1, @resource=#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278 ...>>, #<Lims::Core::Persistence::Revision:0x007f9c6415b1e0 @action="update", @number=2, @session_id=2>]>, #<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970 @name="John">=>#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0 @resource=#<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970 @name="John">, @persistor=#<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268 ...>, @id=2, @to_delete=false, @last_dirty_key="7a4a69e09c57f13cbdc0a7ff43c314629e0a5f32", @parents_saved=nil, @children_saved=nil, @body_saved=nil, @revision=[#<Lims::Core::Persistence::Revision:0x007f9c641dc8f8 @action="insert", @number=1, @session_id=4, @resource=#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0 ...>>]>}, @dataset=#<Sequel::SQLite::Dataset: "SELECT * FROM `names_revision`">, @qualified_key=#<Sequel::SQL::QualifiedIdentifier @table=>:names_revision, @column=>:id>>>, @id=1, @to_delete=false, @last_dirty_key="d7d3ac1ee01a55c2355fc7d3f142257fbe14c58c", @parents_saved=nil, @children_saved=nil, @body_saved=nil, @revision=[#<Lims::Core::Persistence::Revision:0x007f9c6423dec8 @action="insert", @number=1, @session_id=1, @resource=#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c6416d278 ...>>, #<Lims::Core::Persistence::Revision:0x007f9c64272e70 @action="update", @number=2, @session_id=3>, #<Lims::Core::Persistence::Revision:0x007f9c64271098 @action="update", @number=3, @session_id=4>]>}>] (using ==)
       Diff:
       @@ -1,2 +1,525 @@
       -[1, 2, 3, 4]
       +[#<Lims::Core::Persistence::StateGroup: {#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c6416d278
       +   @body_saved=nil,
       +   @children_saved=nil,
       +   @id=1,
       +   @last_dirty_key="d7d3ac1ee01a55c2355fc7d3f142257fbe14c58c",
       +   @parents_saved=nil,
       +   @persistor=
       +    #<Lims::Core::Persistence::ForTest::User::UserSequelRevisionPersistor:0x007f9c64181408
       +     @dataset=#<Sequel::SQLite::Dataset: "SELECT * FROM `users_revision`">,
       +     @id_to_state=
       +      {1=>
       +        #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c6416d278
       +         ...>},
       +     @object_to_state=
       +      {#<Lims::Core::Persistence::ForTest::User:0x007f9c642685b0
       +        @email="john.smith@example.com",
       +        @name=
       +         #<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90
       +          @name="jon">>=>
       +        #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c6416d278
       +         ...>},
       +     @qualified_key=
       +      #<Sequel::SQL::QualifiedIdentifier @table=>:users_revision, @column=>:id>,
       +     @session=
       +      #<Lims::Core::Persistence::Sequel::Revision::Session:0x007f9c64166360
       +       @backend_application_id=nil,
       +       @dirty_attribute_strategy=2,
       +       @in_session=false,
       +       @object_states=
       +        #<Lims::Core::Persistence::StateList: {#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c6416d278
       +          ...>,
       +         #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278
       +          @body_saved=nil,
       +          @children_saved=nil,
       +          @id=1,
       +          @last_dirty_key="ffc2b6e3fa60e5d56f686a61bd27deee712030f4",
       +          @parents_saved=nil,
       +          @persistor=
       +           #<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268
       +            @dataset=
       +             #<Sequel::SQLite::Dataset: "SELECT * FROM `names_revision`">,
       +            @id_to_state=
       +             {1=>
       +               #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278
       +                ...>,
       +              2=>
       +               #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0
       +                @body_saved=nil,
       +                @children_saved=nil,
       +                @id=2,
       +                @last_dirty_key="7a4a69e09c57f13cbdc0a7ff43c314629e0a5f32",
       +                @parents_saved=nil,
       +                @persistor=
       +                 #<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268
       +                  ...>,
       +                @resource=
       +                 #<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970
       +                  @name="John">,
       +                @revision=
       +                 [#<Lims::Core::Persistence::Revision:0x007f9c641dc8f8
       +                   @action="insert",
       +                   @number=1,
       +                   @resource=
       +                    #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0
       +                     ...>,
       +                   @session_id=4>],
       +                @to_delete=false>},
       +            @object_to_state=
       +             {#<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90
       +               @name="jon">=>
       +               #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278
       +                ...>,
       +              #<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970
       +               @name="John">=>
       +               #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0
       +                @body_saved=nil,
       +                @children_saved=nil,
       +                @id=2,
       +                @last_dirty_key="7a4a69e09c57f13cbdc0a7ff43c314629e0a5f32",
       +                @parents_saved=nil,
       +                @persistor=
       +                 #<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268
       +                  ...>,
       +                @resource=
       +                 #<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970
       +                  @name="John">,
       +                @revision=
       +                 [#<Lims::Core::Persistence::Revision:0x007f9c641dc8f8
       +                   @action="insert",
       +                   @number=1,
       +                   @resource=
       +                    #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0
       +                     ...>,
       +                   @session_id=4>],
       +                @to_delete=false>},
       +            @qualified_key=
       +             #<Sequel::SQL::QualifiedIdentifier @table=>:names_revision, @column=>:id>,
       +            @session=
       +             #<Lims::Core::Persistence::Sequel::Revision::Session:0x007f9c64166360
       +              ...>>,
       +          @resource=
       +           #<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90
       +            @name="jon">,
       +          @revision=
       +           [#<Lims::Core::Persistence::Revision:0x007f9c64211f58
       +             @action="insert",
       +             @number=1,
       +             @resource=
       +              #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278
       +               ...>,
       +             @session_id=1>,
       +            #<Lims::Core::Persistence::Revision:0x007f9c6415b1e0
       +             @action="update",
       +             @number=2,
       +             @session_id=2>],
       +          @to_delete=false>,
       +         #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0
       +          @body_saved=nil,
       +          @children_saved=nil,
       +          @id=2,
       +          @last_dirty_key="7a4a69e09c57f13cbdc0a7ff43c314629e0a5f32",
       +          @parents_saved=nil,
       +          @persistor=
       +           #<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268
       +            @dataset=
       +             #<Sequel::SQLite::Dataset: "SELECT * FROM `names_revision`">,
       +            @id_to_state=
       +             {1=>
       +               #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278
       +                @body_saved=nil,
       +                @children_saved=nil,
       +                @id=1,
       +                @last_dirty_key="ffc2b6e3fa60e5d56f686a61bd27deee712030f4",
       +                @parents_saved=nil,
       +                @persistor=
       +                 #<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268
       +                  ...>,
       +                @resource=
       +                 #<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90
       +                  @name="jon">,
       +                @revision=
       +                 [#<Lims::Core::Persistence::Revision:0x007f9c64211f58
       +                   @action="insert",
       +                   @number=1,
       +                   @resource=
       +                    #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278
       +                     ...>,
       +                   @session_id=1>,
       +                  #<Lims::Core::Persistence::Revision:0x007f9c6415b1e0
       +                   @action="update",
       +                   @number=2,
       +                   @session_id=2>],
       +                @to_delete=false>,
       +              2=>
       +               #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0
       +                ...>},
       +            @object_to_state=
       +             {#<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90
       +               @name="jon">=>
       +               #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278
       +                @body_saved=nil,
       +                @children_saved=nil,
       +                @id=1,
       +                @last_dirty_key="ffc2b6e3fa60e5d56f686a61bd27deee712030f4",
       +                @parents_saved=nil,
       +                @persistor=
       +                 #<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268
       +                  ...>,
       +                @resource=
       +                 #<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90
       +                  @name="jon">,
       +                @revision=
       +                 [#<Lims::Core::Persistence::Revision:0x007f9c64211f58
       +                   @action="insert",
       +                   @number=1,
       +                   @resource=
       +                    #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278
       +                     ...>,
       +                   @session_id=1>,
       +                  #<Lims::Core::Persistence::Revision:0x007f9c6415b1e0
       +                   @action="update",
       +                   @number=2,
       +                   @session_id=2>],
       +                @to_delete=false>,
       +              #<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970
       +               @name="John">=>
       +               #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0
       +                ...>},
       +            @qualified_key=
       +             #<Sequel::SQL::QualifiedIdentifier @table=>:names_revision, @column=>:id>,
       +            @session=
       +             #<Lims::Core::Persistence::Sequel::Revision::Session:0x007f9c64166360
       +              ...>>,
       +          @resource=
       +           #<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970
       +            @name="John">,
       +          @revision=
       +           [#<Lims::Core::Persistence::Revision:0x007f9c641dc8f8
       +             @action="insert",
       +             @number=1,
       +             @resource=
       +              #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0
       +               ...>,
       +             @session_id=4>],
       +          @to_delete=false>}>,
       +       @parameters=nil,
       +       @persistor_map=
       +        {Lims::Core::Persistence::ForTest::User=>
       +          #<Lims::Core::Persistence::ForTest::User::UserSequelRevisionPersistor:0x007f9c64181408
       +           ...>,
       +         Lims::Core::Persistence::ForTest::Name=>
       +          #<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268
       +           @dataset=
       +            #<Sequel::SQLite::Dataset: "SELECT * FROM `names_revision`">,
       +           @id_to_state=
       +            {1=>
       +              #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278
       +               @body_saved=nil,
       +               @children_saved=nil,
       +               @id=1,
       +               @last_dirty_key="ffc2b6e3fa60e5d56f686a61bd27deee712030f4",
       +               @parents_saved=nil,
       +               @persistor=
       +                #<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268
       +                 ...>,
       +               @resource=
       +                #<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90
       +                 @name="jon">,
       +               @revision=
       +                [#<Lims::Core::Persistence::Revision:0x007f9c64211f58
       +                  @action="insert",
       +                  @number=1,
       +                  @resource=
       +                   #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278
       +                    ...>,
       +                  @session_id=1>,
       +                 #<Lims::Core::Persistence::Revision:0x007f9c6415b1e0
       +                  @action="update",
       +                  @number=2,
       +                  @session_id=2>],
       +               @to_delete=false>,
       +             2=>
       +              #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0
       +               @body_saved=nil,
       +               @children_saved=nil,
       +               @id=2,
       +               @last_dirty_key="7a4a69e09c57f13cbdc0a7ff43c314629e0a5f32",
       +               @parents_saved=nil,
       +               @persistor=
       +                #<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268
       +                 ...>,
       +               @resource=
       +                #<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970
       +                 @name="John">,
       +               @revision=
       +                [#<Lims::Core::Persistence::Revision:0x007f9c641dc8f8
       +                  @action="insert",
       +                  @number=1,
       +                  @resource=
       +                   #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0
       +                    ...>,
       +                  @session_id=4>],
       +               @to_delete=false>},
       +           @object_to_state=
       +            {#<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90
       +              @name="jon">=>
       +              #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278
       +               @body_saved=nil,
       +               @children_saved=nil,
       +               @id=1,
       +               @last_dirty_key="ffc2b6e3fa60e5d56f686a61bd27deee712030f4",
       +               @parents_saved=nil,
       +               @persistor=
       +                #<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268
       +                 ...>,
       +               @resource=
       +                #<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90
       +                 @name="jon">,
       +               @revision=
       +                [#<Lims::Core::Persistence::Revision:0x007f9c64211f58
       +                  @action="insert",
       +                  @number=1,
       +                  @resource=
       +                   #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278
       +                    ...>,
       +                  @session_id=1>,
       +                 #<Lims::Core::Persistence::Revision:0x007f9c6415b1e0
       +                  @action="update",
       +                  @number=2,
       +                  @session_id=2>],
       +               @to_delete=false>,
       +             #<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970
       +              @name="John">=>
       +              #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0
       +               @body_saved=nil,
       +               @children_saved=nil,
       +               @id=2,
       +               @last_dirty_key="7a4a69e09c57f13cbdc0a7ff43c314629e0a5f32",
       +               @parents_saved=nil,
       +               @persistor=
       +                #<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268
       +                 ...>,
       +               @resource=
       +                #<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970
       +                 @name="John">,
       +               @revision=
       +                [#<Lims::Core::Persistence::Revision:0x007f9c641dc8f8
       +                  @action="insert",
       +                  @number=1,
       +                  @resource=
       +                   #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0
       +                    ...>,
       +                  @session_id=4>],
       +               @to_delete=false>},
       +           @qualified_key=
       +            #<Sequel::SQL::QualifiedIdentifier @table=>:names_revision, @column=>:id>,
       +           @session=
       +            #<Lims::Core::Persistence::Sequel::Revision::Session:0x007f9c64166360
       +             ...>>},
       +       @saved=#<Set: {}>,
       +       @session_id=nil,
       +       @store=
       +        #<Lims::Core::Persistence::Sequel::Store:0x007f9c6292ed38
       +         @database=
       +          #<Sequel::SQLite::Database: {:adapter=>:sqlite, :database=>"", :loggers=>[]}>,
       +         @dirty_attribute_strategy=2>,
       +       @user=nil>,
       +     @session_name=
       +      #<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268
       +       @dataset=#<Sequel::SQLite::Dataset: "SELECT * FROM `names_revision`">,
       +       @id_to_state=
       +        {1=>
       +          #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278
       +           @body_saved=nil,
       +           @children_saved=nil,
       +           @id=1,
       +           @last_dirty_key="ffc2b6e3fa60e5d56f686a61bd27deee712030f4",
       +           @parents_saved=nil,
       +           @persistor=
       +            #<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268
       +             ...>,
       +           @resource=
       +            #<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90
       +             @name="jon">,
       +           @revision=
       +            [#<Lims::Core::Persistence::Revision:0x007f9c64211f58
       +              @action="insert",
       +              @number=1,
       +              @resource=
       +               #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278
       +                ...>,
       +              @session_id=1>,
       +             #<Lims::Core::Persistence::Revision:0x007f9c6415b1e0
       +              @action="update",
       +              @number=2,
       +              @session_id=2>],
       +           @to_delete=false>,
       +         2=>
       +          #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0
       +           @body_saved=nil,
       +           @children_saved=nil,
       +           @id=2,
       +           @last_dirty_key="7a4a69e09c57f13cbdc0a7ff43c314629e0a5f32",
       +           @parents_saved=nil,
       +           @persistor=
       +            #<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268
       +             ...>,
       +           @resource=
       +            #<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970
       +             @name="John">,
       +           @revision=
       +            [#<Lims::Core::Persistence::Revision:0x007f9c641dc8f8
       +              @action="insert",
       +              @number=1,
       +              @resource=
       +               #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0
       +                ...>,
       +              @session_id=4>],
       +           @to_delete=false>},
       +       @object_to_state=
       +        {#<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90
       +          @name="jon">=>
       +          #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278
       +           @body_saved=nil,
       +           @children_saved=nil,
       +           @id=1,
       +           @last_dirty_key="ffc2b6e3fa60e5d56f686a61bd27deee712030f4",
       +           @parents_saved=nil,
       +           @persistor=
       +            #<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268
       +             ...>,
       +           @resource=
       +            #<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90
       +             @name="jon">,
       +           @revision=
       +            [#<Lims::Core::Persistence::Revision:0x007f9c64211f58
       +              @action="insert",
       +              @number=1,
       +              @resource=
       +               #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278
       +                ...>,
       +              @session_id=1>,
       +             #<Lims::Core::Persistence::Revision:0x007f9c6415b1e0
       +              @action="update",
       +              @number=2,
       +              @session_id=2>],
       +           @to_delete=false>,
       +         #<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970
       +          @name="John">=>
       +          #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0
       +           @body_saved=nil,
       +           @children_saved=nil,
       +           @id=2,
       +           @last_dirty_key="7a4a69e09c57f13cbdc0a7ff43c314629e0a5f32",
       +           @parents_saved=nil,
       +           @persistor=
       +            #<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268
       +             ...>,
       +           @resource=
       +            #<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970
       +             @name="John">,
       +           @revision=
       +            [#<Lims::Core::Persistence::Revision:0x007f9c641dc8f8
       +              @action="insert",
       +              @number=1,
       +              @resource=
       +               #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0
       +                ...>,
       +              @session_id=4>],
       +           @to_delete=false>},
       +       @qualified_key=
       +        #<Sequel::SQL::QualifiedIdentifier @table=>:names_revision, @column=>:id>,
       +       @session=
       +        #<Lims::Core::Persistence::Sequel::Revision::Session:0x007f9c64166360
       +         @backend_application_id=nil,
       +         @dirty_attribute_strategy=2,
       +         @in_session=false,
       +         @object_states=
       +          #<Lims::Core::Persistence::StateList: {#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c6416d278
       +            ...>,
       +           #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278
       +            @body_saved=nil,
       +            @children_saved=nil,
       +            @id=1,
       +            @last_dirty_key="ffc2b6e3fa60e5d56f686a61bd27deee712030f4",
       +            @parents_saved=nil,
       +            @persistor=
       +             #<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268
       +              ...>,
       +            @resource=
       +             #<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90
       +              @name="jon">,
       +            @revision=
       +             [#<Lims::Core::Persistence::Revision:0x007f9c64211f58
       +               @action="insert",
       +               @number=1,
       +               @resource=
       +                #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fe278
       +                 ...>,
       +               @session_id=1>,
       +              #<Lims::Core::Persistence::Revision:0x007f9c6415b1e0
       +               @action="update",
       +               @number=2,
       +               @session_id=2>],
       +            @to_delete=false>,
       +           #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0
       +            @body_saved=nil,
       +            @children_saved=nil,
       +            @id=2,
       +            @last_dirty_key="7a4a69e09c57f13cbdc0a7ff43c314629e0a5f32",
       +            @parents_saved=nil,
       +            @persistor=
       +             #<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268
       +              ...>,
       +            @resource=
       +             #<Lims::Core::Persistence::ForTest::Name:0x007f9c64240970
       +              @name="John">,
       +            @revision=
       +             [#<Lims::Core::Persistence::Revision:0x007f9c641dc8f8
       +               @action="insert",
       +               @number=1,
       +               @resource=
       +                #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c641fdfd0
       +                 ...>,
       +               @session_id=4>],
       +            @to_delete=false>}>,
       +         @parameters=nil,
       +         @persistor_map=
       +          {Lims::Core::Persistence::ForTest::User=>
       +            #<Lims::Core::Persistence::ForTest::User::UserSequelRevisionPersistor:0x007f9c64181408
       +             ...>,
       +           Lims::Core::Persistence::ForTest::Name=>
       +            #<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c641ff268
       +             ...>},
       +         @saved=#<Set: {}>,
       +         @session_id=nil,
       +         @store=
       +          #<Lims::Core::Persistence::Sequel::Store:0x007f9c6292ed38
       +           @database=
       +            #<Sequel::SQLite::Database: {:adapter=>:sqlite, :database=>"", :loggers=>[]}>,
       +           @dirty_attribute_strategy=2>,
       +         @user=nil>>>,
       +   @resource=
       +    #<Lims::Core::Persistence::ForTest::User:0x007f9c642685b0
       +     @email="john.smith@example.com",
       +     @name=
       +      #<Lims::Core::Persistence::ForTest::Name:0x007f9c64215f90 @name="jon">>,
       +   @revision=
       +    [#<Lims::Core::Persistence::Revision:0x007f9c6423dec8
       +      @action="insert",
       +      @number=1,
       +      @resource=
       +       #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c6416d278
       +        ...>,
       +      @session_id=1>,
       +     #<Lims::Core::Persistence::Revision:0x007f9c64272e70
       +      @action="update",
       +      @number=2,
       +      @session_id=3>,
       +     #<Lims::Core::Persistence::Revision:0x007f9c64271098
       +      @action="update",
       +      @number=3,
       +      @session_id=4>],
       +   @to_delete=false>}>]
     # ./spec/persistence/sequel/revision/session_spec.rb:136:in `block (2 levels) in it_finds_correct_revision'
     # ./lib/lims-core/persistence/session.rb:74:in `[]'
     # ./lib/lims-core/persistence/session.rb:74:in `with_session'
     # ./lib/lims-core/persistence/sequel/session.rb:84:in `block in with_session'
     # ./lib/lims-core/persistence/sequel/session.rb:96:in `call'
     # ./lib/lims-core/persistence/sequel/session.rb:96:in `with_current_session'
     # ./lib/lims-core/persistence/sequel/session.rb:83:in `with_session'
     # ./lib/lims-core/persistence/store.rb:53:in `with_session'
     # ./spec/persistence/sequel/revision/session_spec.rb:134:in `block in it_finds_correct_revision'

  2) Lims::Core::Persistence::Sequel::Revision::Session With sql test store with object history#linked objects for a specific resource find the correct revision 
     Failure/Error: session.user_session.send(:session_ids_for, resource_state).should ==  session_ids
       expected: [1, 2, 4]
            got: [#<Lims::Core::Persistence::StateGroup: {#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c6453fd10 @resource=#<Lims::Core::Persistence::ForTest::Name:0x007f9c646b06b8 @name="jon">, @persistor=#<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c64540058 @session=#<Lims::Core::Persistence::Sequel::Revision::Session:0x007f9c64540918 @store=#<Lims::Core::Persistence::Sequel::Store:0x007f9c6292ed38 @database=#<Sequel::SQLite::Database: {:adapter=>:sqlite, :database=>"", :loggers=>[]}>, @dirty_attribute_strategy=2>, @session_id=nil, @object_states=#<Lims::Core::Persistence::StateList: {#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c6453fd10 ...>}>, @in_session=false, @saved=#<Set: {}>, @persistor_map={Lims::Core::Persistence::ForTest::Name=>#<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c64540058 ...>}, @dirty_attribute_strategy=2, @user=nil, @backend_application_id=nil, @parameters=nil>, @id_to_state={1=>#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c6453fd10 ...>}, @object_to_state={#<Lims::Core::Persistence::ForTest::Name:0x007f9c646b06b8 @name="jon">=>#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c6453fd10 ...>}, @dataset=#<Sequel::SQLite::Dataset: "SELECT * FROM `names_revision`">, @qualified_key=#<Sequel::SQL::QualifiedIdentifier @table=>:names_revision, @column=>:id>>, @id=1, @to_delete=false, @last_dirty_key="ffc2b6e3fa60e5d56f686a61bd27deee712030f4", @parents_saved=nil, @children_saved=nil, @body_saved=nil, @revision=[#<Lims::Core::Persistence::Revision:0x007f9c6453dec0 @action="insert", @number=1, @session_id=1, @resource=#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c6453fd10 ...>>, #<Lims::Core::Persistence::Revision:0x007f9c646aff38 @action="update", @number=2, @session_id=2>]>}>] (using ==)
       Diff:
       @@ -1,2 +1,56 @@
       -[1, 2, 4]
       +[#<Lims::Core::Persistence::StateGroup: {#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c6453fd10
       +   @body_saved=nil,
       +   @children_saved=nil,
       +   @id=1,
       +   @last_dirty_key="ffc2b6e3fa60e5d56f686a61bd27deee712030f4",
       +   @parents_saved=nil,
       +   @persistor=
       +    #<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c64540058
       +     @dataset=#<Sequel::SQLite::Dataset: "SELECT * FROM `names_revision`">,
       +     @id_to_state=
       +      {1=>
       +        #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c6453fd10
       +         ...>},
       +     @object_to_state=
       +      {#<Lims::Core::Persistence::ForTest::Name:0x007f9c646b06b8 @name="jon">=>
       +        #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c6453fd10
       +         ...>},
       +     @qualified_key=
       +      #<Sequel::SQL::QualifiedIdentifier @table=>:names_revision, @column=>:id>,
       +     @session=
       +      #<Lims::Core::Persistence::Sequel::Revision::Session:0x007f9c64540918
       +       @backend_application_id=nil,
       +       @dirty_attribute_strategy=2,
       +       @in_session=false,
       +       @object_states=
       +        #<Lims::Core::Persistence::StateList: {#<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c6453fd10
       +          ...>}>,
       +       @parameters=nil,
       +       @persistor_map=
       +        {Lims::Core::Persistence::ForTest::Name=>
       +          #<Lims::Core::Persistence::ForTest::Name::NameSequelRevisionPersistor:0x007f9c64540058
       +           ...>},
       +       @saved=#<Set: {}>,
       +       @session_id=nil,
       +       @store=
       +        #<Lims::Core::Persistence::Sequel::Store:0x007f9c6292ed38
       +         @database=
       +          #<Sequel::SQLite::Database: {:adapter=>:sqlite, :database=>"", :loggers=>[]}>,
       +         @dirty_attribute_strategy=2>,
       +       @user=nil>>,
       +   @resource=
       +    #<Lims::Core::Persistence::ForTest::Name:0x007f9c646b06b8 @name="jon">,
       +   @revision=
       +    [#<Lims::Core::Persistence::Revision:0x007f9c6453dec0
       +      @action="insert",
       +      @number=1,
       +      @resource=
       +       #<Lims::Core::Persistence::Sequel::Revision::Persistor::ResourceState:0x007f9c6453fd10
       +        ...>,
       +      @session_id=1>,
       +     #<Lims::Core::Persistence::Revision:0x007f9c646aff38
       +      @action="update",
       +      @number=2,
       +      @session_id=2>],
       +   @to_delete=false>}>]
     # ./spec/persistence/sequel/revision/session_spec.rb:136:in `block (2 levels) in it_finds_correct_revision'
     # ./lib/lims-core/persistence/session.rb:74:in `[]'
     # ./lib/lims-core/persistence/session.rb:74:in `with_session'
     # ./lib/lims-core/persistence/sequel/session.rb:84:in `block in with_session'
     # ./lib/lims-core/persistence/sequel/session.rb:96:in `call'
     # ./lib/lims-core/persistence/sequel/session.rb:96:in `with_current_session'
     # ./lib/lims-core/persistence/sequel/session.rb:83:in `with_session'
     # ./lib/lims-core/persistence/store.rb:53:in `with_session'
     # ./spec/persistence/sequel/revision/session_spec.rb:134:in `block in it_finds_correct_revision'

Finished in 0.10523 seconds
2 examples, 2 failures

Failed examples:

rspec ./spec/persistence/sequel/revision/session_spec.rb:133 # Lims::Core::Persistence::Sequel::Revision::Session With sql test store with object history#linked objects for a specific resource find the correct revision 
rspec ./spec/persistence/sequel/revision/session_spec.rb:133 # Lims::Core::Persistence::Sequel::Revision::Session With sql test store with object history#linked objects for a specific resource find the correct revision 
